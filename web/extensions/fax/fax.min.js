var fax_ext_name="fax",fax={first_time:!0,stop_start_state:0,winH:400,winSBW:15,n_menu:4,menu0:-1,menu1:-1,menu2:-1,menu3:-1,contrast:1,file:0,ch:0,data_canvas:0,copy_canvas:0,lpm:120,lpm_i:3,lpm_s:[60,90,100,120,180,240]};function fax_main(){ext_switch_to_client(fax_ext_name,fax.first_time,fax_recv),fax.first_time||fax_controls_setup(),fax.first_time=!1}var fax_tw,fax_scope_colors=["black","red"],fax_image_y=0,fax_w=1024,fax_h=2048,fax_startx=150,fax_mkr=0;function fax_clear_display(){var a=fax.data_canvas.ctx;a.fillStyle="black",a.fillRect(0,0,fax_startx,fax_h),a.fillStyle="lightCyan",a.fillRect(fax_startx,0,fax_w,fax_h),fax_image_y=0}var fax_cmd={CLEAR:255,DRAW:254};function fax_recv(a){var e=fax.data_canvas,t=e.ctx;if("DAT"!=arrayBufferToStringLen(a,3)){var _=arrayBufferToString(a).substring(4).split(" ");for(o=0;o<_.length;o++){var f=_[o].split("=");switch(f[0]){case"ready":fax_controls_setup(),fax.ch=parseInt(f[1]);break;case"fax_download_avail":var i=kiwi_url_origin()+"/kiwi.config/fax.ch"+fax.ch+"_"+f[1],x=i+".png",n=i+".thumb.png";w3_remove_then_add("id-fax-file-icon1","fa-circle-o-notch fa-refresh fa-spin w3-text-aqua","fa-circle w3-text-pink"),w3_add("id-fax-file-icon2","w3-hide"),w3_el("id-fax-file-status").innerHTML=w3_link("",x,"<img src="+dq(n)+" />");break;case"fax_sps_changed":if(fax_mkr)(t=e.ctx).fillStyle="red",t.fillRect(fax_startx-fax_mkr,fax_image_y-1,fax_mkr,1);break;case"fax_record_line":var s=w3_el("id-fax-line");s&&(s.innerHTML=f[1]);break;default:console.log("fax_recv: UNKNOWN CMD "+f[0])}}}else{var l=new Uint8Array(a,4),r=l[0];if(r==fax_cmd.CLEAR)fax_clear_display();else if(r==fax_cmd.DRAW){for(var c=e.imd,o=0;o<fax_w;o++)c.data[4*o+0]=l[o+1],c.data[4*o+1]=l[o+1],c.data[4*o+2]=l[o+1],c.data[4*o+3]=255;var d=w3_el("id-fax-data").scrollTop,w=d+fax.winH;if(fax_image_y>=d&&fax_image_y<=w)fax_image_y>=w&&(w3_el("id-fax-data").scrollTop=fax_image_y+1-fax.winH);if(fax_image_y<fax_h)fax_image_y++;else{var p=fax_w+fax_mkr,m=fax_startx-fax_mkr;t.drawImage(e,m,1,p,fax_h-1,m,0,p,fax_h-1),fax_mkr&&(t.fillStyle="black",t.fillRect(fax_startx-fax_mkr,fax_image_y-1,fax_mkr,1))}t.putImageData(c,fax_startx,fax_image_y-1)}else{var u=r;t.fillStyle=fax_scope_colors[u];for(var o=0;o<fax_w;o++)t.fillRect(fax_startx+o,l[o+1],1,1)}}}var fax_disabled,fax_prev_disabled,fax_europe={Hamburg:[],"DDH/K DE":[3855,7880,13882.5,15988],Northwood:[],"GYA UK":[2618.5,4610,6834,8040,11086.5],Athens:[],"SVJ4 GR":[4482.9,8106.9],Murmansk:[],"RBW RU":[5336,"6328.5 lsb",7908.8,8444.1,10130],Sevastopol:[],"GM-11F UR":[5103,7090]},fax_asia_pac={"Pt. Reyes":[],"NMC US":[4346,8682,12786,17151.2,22527],Honolulu:[],"KVM70 HI":[9982.5,11090,16135],Kodiak:[],"NOJ AK":[2054,4298,8459,12412.5],Wellington:[],"ZKLF NZ":[3247.4,5807,9459,13550.5,16340.1],Charleville:[],"VMC AU":[2628,5100,11030,13920,20469],Wiluna:[],"VMW AU":[5755,7535,10555,15615,18060],Tokyo:[],"JMH JP":[3622.5,7795,13988.5],"JFC/JFW/JFX":[],JP:[6414.5,8658,16907.5,22559.6],Kyodo:[],"JJC/JSC JP":["4316/60","8467.5/60","12745.5/60","16971/60","17069.6/60","22542/60"],Seoul:[],"HLL2 KR":[3585,5857.5,7433.5,9165,13570],Shanghai:[],"XSG, CN":[4170,8302,12382,16559],Bangkok:[],"HSW64 TH":[7396.9],Singapore:[],"9VF SG":[16035,17430]},fax_americas={"Pt. Reyes":[],"NMC US":[4346,8682,12786,17151.2,22527],"New Orleans":[],"NMG US":[4317.9,8503.9,12789.9,17146.4],Boston:[],"NMF US":[4235,6340.5,9110,12750],Kodiak:[],"NOJ AK":[2054,4298,8459,12412.5],"Nova Scotia":[],"VCO CA":[4416,6915.1],Iqaluit:[],"VFF CA":[3253,7710],Resolute:[],"VFR CA":[3253,7710],Inuvik:[],"VFA CA":[4292,8456],Brazil:[],"PWZ33 BR":[12665,16978],Chile:[],"CBV/M CL":[4228,4322,8677,8696,17146.4]},fax_africa={"S. Africa":[],"ZSJ SA":[4014,7508,13538,18238]};function fax_controls_setup(){kiwi_isMobile()&&(fax_startx=0),fax_tw=fax_startx+fax_w+fax.winSBW;var a=time_display_html("fax")+w3_div("id-fax-data|left:0; width:"+px(fax_tw)+"; height:"+px(fax.winH)+"; background-color:black; position:relative; overflow-y:scroll; overflow-x:hidden",'<canvas id="id-fax-data-canvas" width='+dq(fax_tw)+' style="left:'+px(0)+'; position:absolute;"></canvas>','<canvas id="id-fax-copy-canvas" width='+dq(fax_tw)+' style="left:'+px(0)+'; position:absolute;z-index:-1;"></canvas>'),e=w3_div("id-fax-controls w3-text-white",w3_divs("w3-container/w3-tspace-8",w3_col_percent("",w3_div("w3-medium w3-text-aqua","<b>HF FAX decoder</b>"),30,w3_div("id-fax-station w3-text-css-yellow"),60,w3_div(),10),w3_col_percent("",w3_select_hier("w3-text-red","Europe","select","fax.menu0",fax.menu0,fax_europe,"fax_pre_select_cb"),25,w3_select_hier("w3-text-red","Asia/Pacific","select","fax.menu1",fax.menu1,fax_asia_pac,"fax_pre_select_cb"),25,w3_select_hier("w3-text-red","Americas","select","fax.menu2",fax.menu2,fax_americas,"fax_pre_select_cb"),25,w3_select_hier("w3-text-red","Africa","select","fax.menu3",fax.menu3,fax_africa,"fax_pre_select_cb"),25),w3_inline("/w3-margin-between-16",w3_select("|color:red","","LPM","fax.lpm_i",fax.lpm_i,fax.lpm_s,"fax_lpm_cb"),w3_button("w3-padding-smaller","Next","fax_next_prev_cb",1),w3_button("w3-padding-smaller","Prev","fax_next_prev_cb",-1),w3_button("w3-padding-smaller","Stop","fax_stop_start_cb"),w3_button("w3-padding-smaller","Clear","fax_clear_cb"),w3_inline("",w3_div("",w3_div('fa-stack||title="record"',w3_icon("id-fax-file-icon1","fa-circle fa-nudge-down fa-stack-2x w3-text-pink",22,"","fax_file_cb"),w3_icon("id-fax-file-icon2","fa-stop fa-stack-1x w3-text-pink w3-hide",10,"","fax_file_cb"))),w3_div("id-fax-file-status w3-margin-left"))),w3_div("",w3_link("","www.nws.noaa.gov/os/marine/rfax.pdf","FAX transmission schedules"),w3_div("","Shift-click (PC) or touch (mobile) the image to align."),w3_div("","Please <a href=\"javascript:sendmail('pvsslqwChjtjpgq-`ln');\">report</a> corrections/updates to station frequency menus."))));ext_panel_show(e,a,null),time_display_setup("fax"),fax.data_canvas=w3_el("id-fax-data-canvas"),fax.copy_canvas=w3_el("id-fax-copy-canvas"),fax.data_canvas.ctx=fax.data_canvas.getContext("2d"),fax.copy_canvas.ctx=fax.copy_canvas.getContext("2d"),fax.data_canvas.imd=fax.data_canvas.ctx.createImageData(fax_w,1),fax.data_canvas.addEventListener("mousedown",fax_mousedown,!1),kiwi_isMobile()&&fax.data_canvas.addEventListener("touchstart",fax_touchstart,!1),fax.data_canvas.height=fax_h.toString(),fax.copy_canvas.height=fax_h.toString(),ext_set_data_height(fax.winH),w3_el("id-fax-data").scrollTop=0,fax_clear_display(),ext_set_controls_width_height(550,200);var t=parseFloat(ext_param()),_=!1;if(t)for(var f=0;f<fax.n_menu;f++){var i="fax.menu"+f;w3_select_enum(i,function(a){parseFloat(a.innerHTML)==t&&(fax_pre_select_cb(i,a.value,!1),w3_select_value(i,a.value),_=!0)})}_||ext_set_passband(1400,2400),ext_send("SET fax_start="+fax.lpm)}function fax_pre_select_cb(a,e,t){if(!t){e=+e;var _=parseInt(a.split("fax.menu")[1]);w3_select_enum(a,function(a){if(a.disabled&&(fax_prev_disabled=fax_disabled,fax_disabled=a),a.value==e){var t=a.innerHTML;console.log("fax_pre_select_cb opt.val="+a.value+" opt.inner="+t);var _=t.includes("lsb");ext_tune(parseFloat(t)+(_?1.9:-1.9),_?"lsb":"usb",ext_zoom.ABS,11),ext_set_passband(_?-2400:1400,_?-1400:2400),w3_el("id-fax-station").innerHTML="<b>Station: "+fax_prev_disabled.innerHTML+", "+fax_disabled.innerHTML+"</b>";var f,i=t.split("/"),x=120;i.length>1&&!isNaN(f=parseInt(i[1]))&&(x=f),fax_lpm(x),w3_select_set_if_includes("fax.lpm_i","\\b"+x+"\\b")}});for(var f=0;f<fax.n_menu;f++)f!=_&&w3_select_value("fax.menu"+f,-1)}}function fax_next_prev_cb(a,e,t){e=+e;for(var _,f=0,i=0,x=0,n=0,s=0;s<fax.n_menu;s++){_="fax.menu"+s;var l=w3_el(_).value;if(-1!=l){w3_select_enum(_,function(a){a.disabled||(i&&(x=a.value,i=0),a.value===l&&(n=f,i=1),f=a.value)});break}}l=0,1==e&&x&&(l=x),-1==e&&n&&(l=n),l&&(fax_pre_select_cb(_,l,!1),w3_select_value(_,l))}function fax_mousedown(a){fax_shift(a,!0)}function fax_touchstart(a){fax_shift(a,!1)}function fax_shift(a,e){var t=a.clientX?a.clientX:a.offsetX?a.offsetX:a.layerX,_=fax_startx;if(!(e&&!a.shiftKey||t<_||t>=_+fax_w)){var f=((t-=_)/fax_w).toFixed(6);console.log("FAX offset="+t+" shift="+f);var i=fax.data_canvas,x=fax.copy_canvas,n=i.ctx,s=x.ctx,l=(_=_,fax_h),r=t,c=fax_w-r;s.drawImage(i,_+r,0,c,l,_,0,c,l),n.drawImage(i,_,0,r,l,_+c,0,r,l),n.drawImage(x,_,0,c,l,_,0,c,l),ext_send("SET fax_shift="+f)}}function fax_stop_start_cb(a,e,t){ext_send("SET "+(fax.stop_start_state?"fax_start="+fax.lpm:"fax_stop")),fax.stop_start_state^=1,w3_button_text(a,fax.stop_start_state?"Start":"Stop")}function fax_lpm(a){isNaN(a)||fax.lpm!=a&&(fax.lpm=a,fax.stop_start_state||(ext_send("SET fax_stop"),ext_send("SET fax_start="+fax.lpm)))}function fax_lpm_cb(a,e,t){t||(e=+e,lpm=fax.lpm_s[e],fax_lpm(lpm))}function fax_clear_cb(){fax_clear_display(),fax.file||(w3_remove_then_add("id-fax-file-icon1","fa-circle-o-notch fa-refresh fa-spin w3-text-aqua","fa-circle  w3-text-pink"),w3_add("id-fax-file-icon2","w3-hide"),w3_el("id-fax-file-status").innerHTML="")}function fax_file_cb(a,e,t){fax.file^=1;var _=w3_el("id-fax-file-icon1"),f=w3_el("id-fax-file-icon2");fax.file?(ext_send("SET fax_file_open"),w3_remove_then_add(_,"fa-circle","fa-circle-o-notch fa-spin"),w3_remove(f,"w3-hide"),w3_el("id-fax-file-status").innerHTML=w3_div("w3-show-inline-block","recording<br>line "+w3_div("id-fax-line w3-show-inline-block"))):(ext_send("SET fax_file_close"),w3_remove_then_add(_,"fa-circle-o-notch w3-text-pink","fa-refresh fa-spin w3-text-aqua"),w3_add(f,"w3-hide"),w3_el("id-fax-file-status").innerHTML="processing")}function fax_blur(){ext_send("SET fax_stop"),ext_send("SET fax_close"),ext_set_data_height()}function fax_config_html(){ext_admin_config(fax_ext_name,"fax",w3_div("id-fax w3-text-teal w3-hide","<b>FAX configuration</b><hr>"))}